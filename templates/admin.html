<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Emergency Requests</title>
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 40px auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h2 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
        th { background: #e63946; color: #fff; }
        tr:nth-child(even) { background: #f2f2f2; }
        a { color: #e63946; text-decoration: none; }
        #map { height: 400px; width: 100%; margin-top: 2em; border-radius: 8px; }
    </style>
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@maplibre/maplibre-gl-heatmap@1.0.0/dist/maplibre-gl-heatmap.umd.js"></script>
</head>
<body>
    <div class="container">
        <h2>Emergency Requests - Admin View</h2>
        <div id="map"></div>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Request Type</th>
                </tr>
            </thead>
            <tbody>
                {% for row in requests %}
                <tr>
                    <td>{{ row.id }}</td>
                    <td>{{ row.name }}</td>
                    <td>{{ row.latitude }}</td>
                    <td>{{ row.longitude }}</td>
                    <td>{{ row.request_type }}</td>
                </tr>
                {% else %}
                <tr><td colspan="5">No requests found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <p style="text-align:center; margin-top:2em;"><a href="/">Back to Home</a></p>
    </div>
    <script id="requests-data" type="application/json">
        [{% for row in requests %}{"lat": {{ row.latitude }}, "lng": {{ row.longitude }}, "name": "{{ row.name|escape }}", "type": "{{ row.request_type|escape }}"}{% if not loop.last %},{% endif %}{% endfor %}]
    </script>
    <script>
        const requests = JSON.parse(document.getElementById('requests-data').textContent);
        // India bounds (including PoK)
        const indiaBounds = [
            [6.5, 67.0],   // SW
            [37.2, 97.5]   // NE
        ];
        // MapLibre GL JS setup
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://api.maptiler.com/maps/streets/style.json?key={{ maptiler_key }}',
            center: [78.9629, 22.5937],
            zoom: 5,
            maxBounds: [[67.0, 6.5], [97.5, 37.2]]
        });
        map.addControl(new maplibregl.NavigationControl());

        // Prepare GeoJSON for markers and heatmap
        const geojson = {
            type: 'FeatureCollection',
            features: requests.map(r => ({
                type: 'Feature',
                geometry: { type: 'Point', coordinates: [r.lng, r.lat] },
                properties: { name: r.name, type: r.type }
            }))
        };

        map.on('load', function() {
            // Add heatmap layer
            map.addSource('requests', { type: 'geojson', data: geojson });
            map.addLayer({
                id: 'requests-heat',
                type: 'heatmap',
                source: 'requests',
                maxzoom: 9,
                paint: {
                    'heatmap-weight': 1,
                    'heatmap-intensity': 1.5,
                    'heatmap-radius': 30,
                    'heatmap-opacity': 0.6,
                    'heatmap-color': [
                        'interpolate', ['linear'], ['heatmap-density'],
                        0, 'rgba(0,0,255,0)',
                        0.2, 'blue',
                        0.4, 'lime',
                        0.6, 'yellow',
                        0.8, 'orange',
                        1, 'red'
                    ]
                }
            });
            // Add circle markers
            map.addLayer({
                id: 'requests-points',
                type: 'circle',
                source: 'requests',
                minzoom: 5,
                paint: {
                    'circle-radius': 7,
                    'circle-color': '#e63946',
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });
            // Popup on click
            map.on('click', 'requests-points', function(e) {
                const props = e.features[0].properties;
                new maplibregl.Popup()
                    .setLngLat(e.features[0].geometry.coordinates)
                    .setHTML(`<b>${props.name}</b><br>${props.type}`)
                    .addTo(map);
            });
            // Change cursor on hover
            map.on('mouseenter', 'requests-points', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'requests-points', function() { map.getCanvas().style.cursor = ''; });
        });
    </script>
</body>
</html> 